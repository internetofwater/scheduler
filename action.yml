name: "Geoconnex Scheduler E2E Test"
description: "Reusable GitHub Action to run E2E tests for the Dagster build"
# Allow specifying a custom docker image so we can test specific versions
inputs:
  nabu_image:
    required: true
    description: "Docker image to use for Nabu"
  gleaner_image:
    required: true
    description: "Docker image to use for Gleaner"

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        repository: "internetofwater/scheduler"

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Launch Docker Compose
      run: python3 main.py dev --detach
      shell: bash

    - name: Debug Docker Containers
      shell: bash
      run: docker ps -a

    - name: Check MinIO Logs
      shell: bash
      run: |
        CONTAINER_ID=$(docker ps -q --filter "name=minio")
        if [ -n "$CONTAINER_ID" ]; then
          docker logs $CONTAINER_ID
        else
          echo "MinIO container not found!"
          exit 1
        fi

    - name: Run tests that don't require secrets
      shell: bash
      run: |
        echo "Starting tests"
        python -m venv .venv
        source .venv/bin/activate
        pip install -r requirements.txt
        pytest -x -vv
