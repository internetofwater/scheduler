FROM python:3.10-slim

COPY Docker/user_code_requirements.txt user_code_requirements.txt
RUN pip install -r user_code_requirements.txt

ARG DAGSTER_DEBUG
# dependencies needed for dagster dev
RUN if [ "$DAGSTER_DEBUG" = "true" ]; then pip install debugpy dagster-webserver; fi
RUN echo "User code 'DAGSTER_DEBUG' value is: $DAGSTER_DEBUG"

# Pass the build argument as an environment variable
ENV DAGSTER_DEBUG=$DAGSTER_DEBUG

# configs and runtime code
WORKDIR /opt/dagster/app
COPY code /opt/dagster/app/code
COPY templates /opt/dagster/app/templates

# Expose the necessary ports
EXPOSE 4000
EXPOSE 5678

ENV DAGSTER_HOME=/opt/dagster/app

COPY Docker/entrypoint.sh /opt/dagster/app/entrypoint.sh

# This needs to be a CMD and not an ENTRYPOINT for some reason; it appears that docker swarm might pass implicit arguments and thus not work if it is an ENTRYPOINT
CMD [ "/opt/dagster/app/entrypoint.sh" ]
